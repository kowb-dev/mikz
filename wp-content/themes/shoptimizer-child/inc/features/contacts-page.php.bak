<?php
/**
 * Contacts Page specific functions
 *
 * @package Shoptimizer Child
 * @version 1.0.0
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

// Enqueue styles for the contacts page
add_action('wp_enqueue_scripts', 'mkz_contacts_page_styles');
function mkz_contacts_page_styles() {
	if (is_page('kontakty') || is_page('contacts')) {
		wp_enqueue_style(
			'mkz-contacts-page',
			get_stylesheet_directory_uri() . '/inc/contacts-page.css',
			array('shoptimizer-style'),
			'1.0.0',
			'all'
		);
	}
}

// Add custom body class for contacts page
add_filter('body_class', 'mkz_contacts_page_body_class');
function mkz_contacts_page_body_class($classes) {
	if (is_page('kontakty') || is_page('contacts')) {
		$classes[] = 'mkz-contacts-page';
	}
	return $classes;
}

// Customize Contact Form 7 form classes
add_filter('wpcf7_form_elements', 'mkz_customize_cf7_form');
function mkz_customize_cf7_form($form) {
	if (is_page('kontakty') || is_page('contacts')) {
		$form = str_replace('<form', '<form class="mkz-contact-form-cf7"', $form);
	}
	return $form;
}

// Add Yandex Maps API script
add_action('wp_enqueue_scripts', 'mkz_contacts_yandex_maps_script');
function mkz_contacts_yandex_maps_script() {
	if (is_page('kontakty') || is_page('contacts')) {
		wp_enqueue_script(
			'yandex-maps-api',
			'https://api-maps.yandex.ru/2.1/?lang=ru_RU',
			array(),
			null,
			true
		);

		wp_add_inline_script('yandex-maps-api', '
            ymaps.ready(function() {
                var mkzMap = new ymaps.Map("mkz-yandex-map", {
                    center: [55.742, 37.618], // Москва, Таганская
                    zoom: 16,
                    controls: ["zoomControl", "fullscreenControl"]
                });
                
                var mkzPlacemark = new ymaps.Placemark([55.742, 37.618], {
                    hintContent: "МИКЗ - запчасти для мобильных устройств",
                    balloonContent: "г. Москва, ул. Таганская, д. 25, стр. 1<br><strong>Телефон:</strong> +7 (929) 123-45-67"
                }, {
                    iconLayout: "default#image",
                    iconImageHref: "' . get_stylesheet_directory_uri() . '/assets/images/map-marker.png",
                    iconImageSize: [40, 40],
                    iconImageOffset: [-20, -20]
                });
                
                mkzMap.geoObjects.add(mkzPlacemark);
            });
        ');
	}
}

/**
 * Customizes Contact Form 7 validation messages.
 *
 * @param array $messages The array of messages.
 * @return array The modified array of messages.
 */
function mkz_customize_cf7_messages_filter( $messages ) {
    $messages['mail_sent_ok'] = 'Спасибо! Ваше сообщение отправлено. Мы свяжемся с вами в ближайшее время.';
    $messages['mail_sent_ng'] = 'Произошла ошибка при отправке сообщения. Попробуйте еще раз или позвоните нам.';
    $messages['validation_error'] = 'Пожалуйста, исправьте ошибки в форме и попробуйте снова.';
    $messages['invalid_required'] = 'Это поле обязательно для заполнения.';
    $messages['invalid_email'] = 'Введите корректный email адрес.';
    $messages['invalid_tel'] = 'Введите корректный номер телефона.';

    return $messages;
}
add_filter( 'wpcf7_messages', 'mkz_customize_cf7_messages_filter' );

// Add schema.org structured data for contacts page
add_action('wp_head', 'mkz_contacts_structured_data');
function mkz_contacts_structured_data() {
	if (is_page('kontakty') || is_page('contacts')) {
		$schema = array(
			'@context' => 'https://schema.org',
			'@type' => 'ContactPage',
			'mainEntity' => array(
				'@type' => 'Organization',
				'name' => 'МИКЗ - Запчасти для мобильных устройств',
				'url' => home_url(),
				'telephone' => '+7-929-123-45-67',
				'email' => 'info@mikz33.com',
				'address' => array(
					'@type' => 'PostalAddress',
					'streetAddress' => 'ул. Таганская, д. 25, стр. 1',
					'addressLocality' => 'Москва',
					'addressCountry' => 'RU'
				),
				'openingHours' => array(
					'Mo-Fr 09:00-18:00',
					'Sa-Su 10:00-16:00'
				),
				'sameAs' => array()
			)
		);

		echo '<script type="application/ld+json">' . wp_json_encode($schema, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) . '</script>' . PHP_EOL;
	}
}

// Add geo meta tags for contacts page
add_action('wp_head', 'mkz_contacts_seo_optimization');
function mkz_contacts_seo_optimization() {
	if (is_page('kontakty') || is_page('contacts')) {
		echo '<meta name="geo.region" content="RU-MOW">' . PHP_EOL;
		echo '<meta name="geo.placename" content="Москва">' . PHP_EOL;
		echo '<meta name="geo.position" content="55.742;37.618">' . PHP_EOL;
		echo '<meta name="ICBM" content="55.742, 37.618">' . PHP_EOL;
	}
}

// Add inline styles for Contact Form 7 responsive behavior
add_action('wp_head', 'mkz_contacts_inline_styles');
function mkz_contacts_inline_styles() {
	if (is_page('kontakty') || is_page('contacts')) {
		?>
		<style>
            .wpcf7-form {
                margin: 0;
            }
            .wpcf7-form .wpcf7-response-output {
                margin: var(--space-lg) 0 0 0;
                padding: var(--space-md);
                border-radius: var(--radius-sm);
                font-size: var(--fs-sm);
            }
            .wpcf7-spinner {
                visibility: hidden;
                display: none;
            }
            .wpcf7-form.submitting .mkz-submit-btn {
                opacity: 0.7;
                pointer-events: none;
                position: relative;
            }
            .wpcf7-form.submitting .mkz-submit-btn:after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 20px;
                height: 20px;
                border: 2px solid transparent;
                border-top: 2px solid var(--mkx-white);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: translate(-50%, -50%) rotate(0deg); }
                100% { transform: translate(-50%, -50%) rotate(360deg); }
            }
		</style>
		<?php
	}
}
